#!/bin/bash

set -eu -o pipefail

[[ -f /.dockerenv ]] && { echo "Not supported in Docker. Upgrade the container instead"; exit 0; }

new_cfg=/usr/local/etc/ncp-recommended.cfg
[[ -f "${new_cfg}" ]] || { echo "Already on the lastest recommended distribution. Abort." >&2; exit 1; }

APTINSTALL="apt-get install -y --no-install-recommends"
export DEBIAN_FRONTEND=noninteractive

echo "
>>> ATTENTION <<<
This is a dangerous process that is only guaranteed to work properly if you
have not made manual changes in the system. Backup the SD card first and
proceed at your own risk.

Note that this is not a requirement for NCP to continue working properly.
The current distribution will keep receiving updates for some time.

Do you want to continue? [y/N]"

read key
[[ "$key" == y ]] || exit 0

source /usr/local/etc/library.sh # sets NCPCFG RELEASE PHPVER
old_cfg="${NCPCFG}"

trap "echo 'Something went wrong. Fix it and try again'" EXIT

ncc maintenance:mode --on || true

apt-get update
apt-get upgrade -y

# remove old PHP version
set +e
apt-get purge -y php${PHPVER}:arm64 php${PHPVER}-curl:arm64 php${PHPVER}-gd:arm64 php${PHPVER}-fpm:arm64 php${PHPVER}-cli:arm64 php${PHPVER}-opcache:arm64 \
	php${PHPVER}-mbstring:arm64 php${PHPVER}-xml:arm64 php${PHPVER}-zip:arm64 php${PHPVER}-fileinfo:arm64 php${PHPVER}-ldap:arm64 \
	php${PHPVER}-intl:arm64 php${PHPVER}-bz2:arm64 php${PHPVER}-json:arm64
apt-get purge -y php${PHPVER}-mysql:arm64
apt-get purge -y php${PHPVER}-redis:arm64
apt-get purge -y php${PHPVER}-exif:arm64
apt-get purge -y php${PHPVER}-imagick:arm64
set -e

# update sources
sed -i 's/stretch/buster/g' /etc/apt/sources.list
sed -i 's/stretch/buster/g' /etc/apt/sources.list.d/*
rm -f /etc/apt/sources.list.d/php.list

# install latest distro
apt-get update
apt-get dist-upgrade -y

# install latest PHP version
release_new=$(jq -r '.release'     < "${new_cfg}")
php_ver_new=$(jq -r '.php_version' < "${new_cfg}")

$APTINSTALL -t ${release_new} php${php_ver_new}:arm64 php${php_ver_new}-curl:arm64 php${php_ver_new}-gd:arm64 php${php_ver_new}-fpm:arm64 \ 
        php${php_ver_new}-cli:arm64 php${php_ver_new}-opcache:arm64 \
	php${php_ver_new}-mbstring:arm64 php${php_ver_new}-xml:arm64 php${php_ver_new}-zip:arm64 \
        php${php_ver_new}-fileinfo:arm64 php${php_ver_new}-ldap:arm64 \
	php${php_ver_new}-intl:arm64 php${php_ver_new}-bz2:arm64 php${php_ver_new}-json:arm64

$APTINSTALL php${php_ver_new}-mysql:arm64
$APTINSTALL -t ${release_new} php${php_ver_new}-redis:arm64

$APTINSTALL -t ${release_new} php-smbclient exfat-fuse exfat-utils:arm64
$APTINSTALL -t ${release_new} php${php_ver_new}-exif:arm64
#$APTINSTALL -t ${release_new} imagemagick php${php_ver_new}-imagick ghostscript

apt-get autoremove -y
apt-get clean

# configure latest PHP version
cat > /etc/php/${php_ver_new}/mods-available/opcache.ini <<EOF
zend_extension=opcache.so
opcache.enable=1
opcache.enable_cli=1
opcache.fast_shutdown=1
opcache.interned_strings_buffer=8
opcache.max_accelerated_files=10000
opcache.memory_consumption=128
opcache.save_comments=1
opcache.revalidate_freq=1
opcache.file_cache=/tmp;
EOF

cat > /etc/php/${php_ver_new}/fpm/conf.d/90-ncp.ini <<EOF
; disable .user.ini files for performance and workaround NC update bugs
user_ini.filename =

; from Nextcloud .user.ini
upload_max_filesize=10G
post_max_size=10G
memory_limit=768M
mbstring.func_overload=0
always_populate_raw_post_data=-1
default_charset='UTF-8'
output_buffering=0

; slow transfers will be killed after this time
max_execution_time=3600
max_input_time=3600
EOF

# restart services
service php${php_ver_new}-fpm restart
a2enconf php${php_ver_new}-fpm
service apache2 restart

is_active_app unattended-upgrades && run_app unattended-upgrades || true

# mark as successful
mv "${new_cfg}" "${old_cfg}"

run_app nc-limits
ncc maintenance:mode --off || true

rm -f /etc/update-motd.d/30ncp-dist-upgrade

echo "Upgrade to ${release_new} successful"
trap '' EXIT
