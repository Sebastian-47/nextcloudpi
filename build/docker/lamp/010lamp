#!/bin/bash

source /usr/local/etc/library.sh # sets PHPVER

set -e

[[ "$1" == "stop" ]] && {
  echo "Stopping apache"
  apachectl graceful-stop
  echo "Stopping PHP-fpm"
  pkill -f php-fpm
  echo "Stopping mariaDB"
  mysqladmin -u root shutdown
  echo "LAMP cleanup complete"
  exit 0
}

# MOVE CONFIGS TO PERSISTENT VOLUME
persistent_cfg /etc/apache2

echo "Starting PHP-fpm"
php-fpm${PHPVER}

echo "Starting Apache"
/usr/sbin/apache2ctl start

# adjust the dbdir to the persistent storage
sed -i "s|^data_directory.*|data_directory = /data/database|" /etc/postgresql/${POSTGRES_VER}/main/postgresql.conf

# start
echo "Starting postgresql"
systemctl start postgresql.service

# wait for postgres
while :; do
  [[ -S /run/postgresql/.s.PGSQL.5432 ]] && break
  sleep 0.5
done
sleep 1

exit 0
